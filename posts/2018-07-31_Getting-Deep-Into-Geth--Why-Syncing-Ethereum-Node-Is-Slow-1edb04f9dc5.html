<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Getting Deep Into Geth: Why Syncing Ethereum Node Is Slow</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Getting Deep Into Geth: Why Syncing Ethereum Node Is Slow</h1>
</header>
<section data-field="subtitle" class="p-summary">
Downloading the blocks is just a small part. There is a lot of stuff going on…
</section>
<section data-field="body" class="e-content">
<section name="6e22" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c1b3" id="c1b3" class="graf graf--h3 graf--leading graf--title">Getting Deep Into Geth: Why Syncing Ethereum Node Is Slow</h3><h4 name="259f" id="259f" class="graf graf--h4 graf-after--h3 graf--subtitle">Downloading the blocks is just a small part. There is a lot of stuff going on…</h4></div><div class="section-inner sectionLayout--fullWidth"><figure name="85ce" id="85ce" class="graf graf--figure graf--layoutFillWidth graf-after--h4"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 36%;"></div><img class="graf-image" data-image-id="0*BM8Q_Dkd2RgMidic.png" data-width="1440" data-height="519" src="https://cdn-images-1.medium.com/max/2560/0*BM8Q_Dkd2RgMidic.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><figure name="9762" id="9762" class="graf graf--figure graf--iframe graf-after--figure"><iframe src="https://play.ht/embed/?article_url=https://medium.com/_p/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5" width="700" height="185" frameborder="0" scrolling="no"></iframe></figure><p name="9ca3" id="9ca3" class="graf graf--p graf-after--figure">This post marks the first in a new <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Getting deep into Series</em></strong><em class="markup--em markup--p-em"> </em>I am starting in an effort to provide a deeper understanding of the internal workings and other cool stuff about Ethereum and blockchain in general which you will not find easily on the web.</p><p name="4927" id="4927" class="graf graf--p graf-after--p">In this post we are going to dive into the details of what’s happening behind the scenes when you sync an Ethereum node.</p><p name="1715" id="1715" class="graf graf--p graf-after--p">Syncing Ethereum node is a pain point for many people. Every person working with Ethereum is bound to encounter this.</p><figure name="ba51" id="ba51" class="graf graf--figure graf--iframe graf-after--p"><iframe src="https://tenor.com/embed/6159814" width="600" height="400" frameborder="0" scrolling="no"></iframe><figcaption class="imageCaption">Waiting for Ethereum node to sync</figcaption></figure><p name="f848" id="f848" class="graf graf--p graf-after--figure">The current default mode of sync for Geth is called fast sync. Instead of starting from the genesis block and reprocessing all the transactions that ever occurred (which could take weeks), fast sync downloads the blocks, and only verifies the associated proof-of-works. Downloading all the blocks is a straightforward and fast procedure and will relatively quickly reassemble the entire chain.</p><blockquote name="e9f1" id="e9f1" class="graf graf--blockquote graf-after--p">Many people falsely assume that because they have the blocks, they are in sync.</blockquote><p name="472f" id="472f" class="graf graf--p graf-after--blockquote">Unfortunately this is not the case, since no transaction was executed(i.e. no transaction were run in order to verify the validity of the chain), so we do not have any account state available (i.e. balances, nonces, smart contract code and data). These need to be downloaded separately and cross checked with the latest blocks. This phase is called the <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">state trie download</em></strong> and it actually runs concurrently with the block downloads; alas <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">it take a lot longer nowadays than downloading the blocks.</em></strong></p><p name="4eda" id="4eda" class="graf graf--p graf-after--p">So, what’s the state trie? In the Ethereum mainnet, there are a <a href="https://etherscan.io/chart/address" data-href="https://etherscan.io/chart/address" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">ton of accounts already</a>, which track the balance, nonce, etc of each user/contract.</p><figure name="c5b3" id="c5b3" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 642px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 91.7%;"></div><img class="graf-image" data-image-id="1*lkxrcM34kXqRKzIW1FMFLw.png" data-width="1200" data-height="1100" src="https://cdn-images-1.medium.com/max/800/1*lkxrcM34kXqRKzIW1FMFLw.png"></div><figcaption class="imageCaption"><a href="https://etherscan.io/chart/address" data-href="https://etherscan.io/chart/address" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Source</a></figcaption></figure><p name="509a" id="509a" class="graf graf--p graf-after--figure">The accounts themselves are however insufficient to run a node, they need to be cryptographically linked to each block so that nodes can actually verify that the account’s are not tampered with. This cryptographic linking is done by creating a tree data structure above the accounts, each level aggregating the layer below it into an ever smaller layer, until you reach the single root. This gigantic data structure containing all the accounts and the intermediate cryptographic proofs is called the <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">state trie</em></strong>.</p><p name="aad6" id="aad6" class="graf graf--p graf-after--p">Ok, so why does this pose a problem? This trie data structure is an intricate interlink of hundreds of millions of tiny cryptographic proofs (trie nodes). To truly have a synchronized node, you need to download all the account data, as well as all the tiny cryptographic proofs to verify that none in the network is trying to cheat you. This itself is already a crazy number of data items. The part where it gets even messier is that this data is constantly morphing: at every block (15s), about 1000 nodes are deleted from this trie and about 2000 new ones are added. This means your node needs to synchronize a dataset that is changing 200 times per second. The worst part is that while you are synchronizing, the network is moving forward, and state that you begun to download might disappear while you’re downloading, so your node needs to constantly follow the network while trying to gather all the recent data. But until you actually do gather all the data, your local node is not usable since it cannot cryptographically prove anything about any accounts.</p><p name="4bb3" id="4bb3" class="graf graf--p graf-after--p graf--trailing">If you see that you are 64 blocks behind mainnet, you aren’t yet synchronized, not even close. You are just done with the block download phase and still running the state downloads. You can see this yourself via the seemingly endless <code class="markup--code markup--p-code">Imported state entries [...]</code> stream of logs. You&#39;ll need to wait that out too before your node comes truly online.</p></div></div></section><section name="bff4" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="121a" id="121a" class="graf graf--h4 graf--leading">Q: The node just hangs on importing state enties?</h4><p name="2b62" id="2b62" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">A:</strong> The node doesn’t hang, it just doesn’t know how large the state trie is in advance so it keeps on going and going and going until it discovers and downloads the entire thing.</p><p name="24d5" id="24d5" class="graf graf--p graf-after--p">The reason is that a block in Ethereum only contains the state root, a single hash of the root node. When the node begins synchronizing, it knows about exactly 1 node and tries to download it. That node, can refer up to 16 new nodes, so in the next step, we’ll know about 16 new nodes and try to download those. As we go along the download, most of the nodes will reference new ones that we didn’t know about until then. This is why you might be tempted to think it’s stuck on the same numbers. It is not, rather it’s discovering and downloading the trie as it goes along.</p><h4 name="f3b9" id="f3b9" class="graf graf--h4 graf-after--p">Q: I’m stuck at 64 blocks behind mainnet?</h4><p name="6a3d" id="6a3d" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">A:</strong> As explained above, you are not stuck, just finished with the block download phase, waiting for the state download phase to complete too. This latter phase nowadays take a lot longer than just getting the blocks.</p><h4 name="3232" id="3232" class="graf graf--h4 graf-after--p">Q: Why does downloading the state take so long, I have good bandwidth?</h4><p name="4bae" id="4bae" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">A:</strong> State sync is mostly limited by disk IO, not bandwidth.</p><p name="c35c" id="c35c" class="graf graf--p graf-after--p">The state trie in Ethereum contains hundreds of millions of nodes, most of which take the form of a single hash referencing up to 16 other hashes. This is a horrible way to store data on a disk, because there’s almost no structure in it, just random numbers referencing even more random numbers. This makes any underlying database weep, as it cannot optimize storing and looking up the data in any meaningful way.</p><p name="b772" id="b772" class="graf graf--p graf-after--p">Not only is storing the data very suboptimal, but due to the 200 modification / second and pruning of past data, we cannot even download it is a properly pre-processed way to make it import faster without the underlying database shuffling it around too much. The end result is that even a fast sync nowadays incurs a huge disk IO cost, which is too much for a mechanical hard drive.</p><h4 name="747f" id="747f" class="graf graf--h4 graf-after--p">Q: Wait, so I can’t run a full node on an HDD?</h4><p name="3793" id="3793" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">A:</strong> Unfortunately not. Doing a fast sync on an HDD will take more time than you’re willing to wait with the current data schema. Even if you do wait it out, an HDD will not be able to keep up with the read/write requirements of transaction processing on mainnet.</p><p name="4fed" id="4fed" class="graf graf--p graf-after--p graf--trailing">You however should be able to run a light client on an HDD with minimal impact on system resources. If you wish to run a full node however, an SSD is your only option.</p></div></div></section><section name="c6ad" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="0ceb" id="0ceb" class="graf graf--p graf--leading">Thanks to <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">karalabe</em></strong> for the <a href="https://github.com/ethereum/go-ethereum/issues/16218#issuecomment-371454280" data-href="https://github.com/ethereum/go-ethereum/issues/16218#issuecomment-371454280" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">explanation</em></a>.</p><p name="c25d" id="c25d" class="graf graf--p graf-after--p">Thanks for reading ;)</p><p name="c2bf" id="c2bf" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Still have questions popping up in your head? Shoot them in the comments and I will answer them here or in another article.</strong></p><p name="0410" id="0410" class="graf graf--p graf-after--p">Here is the second part of the Series:</p><div name="bcf9" id="bcf9" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://hackernoon.com/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033" data-href="https://hackernoon.com/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033"><strong class="markup--strong markup--mixtapeEmbed-strong">Getting Deep Into Ethereum: How Data Is Stored In Ethereum?</strong><br><em class="markup--em markup--mixtapeEmbed-em">In this post we will see how states and transactions are stored in Ethereum and how it is different from Bitcoin.</em>hackernoon.com</a><a href="https://hackernoon.com/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="f1c6e01fc190914edbec14aa93c3ae61" data-thumbnail-img-id="1*f0vOn0lRgrY5NjFlbUMBFg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*f0vOn0lRgrY5NjFlbUMBFg.jpeg);"></a></div><h4 name="3073" id="3073" class="graf graf--h4 graf-after--mixtapeEmbed">Learned something? Press and hold the 👏 to say “thanks!” and help others find this article.</h4><p name="abe6" id="abe6" class="graf graf--p graf-after--h4"><em class="markup--em markup--p-em">Hold down the clap button if you liked the content! It helps me gain exposure .</em></p><p name="3a73" id="3a73" class="graf graf--p graf-after--p">Want to learn more? Checkout my previous articles.</p><div name="679d" id="679d" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148" data-href="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148"><strong class="markup--strong markup--mixtapeEmbed-strong">HackPedia: 16 Solidity Hacks/Vulnerabilities, their Fixes and Real World Examples</strong><br><em class="markup--em markup--mixtapeEmbed-em">A Complete List of all Solidity Hacks/Vulnerabilities, their Fixes and Real World Hack Examples</em>hackernoon.com</a><a href="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b42587cd10179acb6cbe0e49c3ba97ad" data-thumbnail-img-id="1*cgEAk9Z51Qi39saBRCJ1Pg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*cgEAk9Z51Qi39saBRCJ1Pg.jpeg);"></a></div><div name="1cb3" id="1cb3" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" data-href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f"><strong class="markup--strong markup--mixtapeEmbed-strong">ConsensusPedia: An Encyclopedia of 30 Consensus Algorithms</strong><br><em class="markup--em markup--mixtapeEmbed-em">A complete list of all consensus algorithms.</em>hackernoon.com</a><a href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="03bbca255c9ab55c0112e7879627edb3" data-thumbnail-img-id="0*y462aeJ4wg8HHYSs" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*y462aeJ4wg8HHYSs);"></a></div><div name="f1ac" id="f1ac" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" data-href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5"><strong class="markup--strong markup--mixtapeEmbed-strong">ContractPedia: An Encyclopedia of 40 Smart Contract Platforms</strong><br><em class="markup--em markup--mixtapeEmbed-em">A Complete List of all Smart Contract supportive Platforms</em>hackernoon.com</a><a href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a949ea9028a00c3bb62dfc3f160efc92" data-thumbnail-img-id="0*zDyDSLiGCSPQHEMq.jpg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*zDyDSLiGCSPQHEMq.jpg);"></a></div><div name="15fe" id="15fe" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" data-href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707"><strong class="markup--strong markup--mixtapeEmbed-strong">Difference between SideChains and State Channels</strong><br><em class="markup--em markup--mixtapeEmbed-em">A complete comparison of the two scaling methods.</em>hackernoon.com</a><a href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="096410b77bc232079dc957910f44555f" data-thumbnail-img-id="1*UmKkLx0_zCrwX1etzE-TRg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*UmKkLx0_zCrwX1etzE-TRg.jpeg);"></a></div><p name="f226" id="f226" class="graf graf--p graf-after--mixtapeEmbed graf--trailing"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Clap 50 times and follow me on Twitter: </em></strong><a href="https://twitter.com/itsmattward" data-href="https://twitter.com/itsmattward" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener nofollow noopener noopener noopener noopener noopener noopener noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">@</em></strong></a><a href="https://twitter.com/vasa_develop" data-href="https://twitter.com/vasa_develop" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener nofollow noopener noopener noopener noopener noopener noopener noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">vasa_develop</em></strong></a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@vaibhavsaini_67863" class="p-author h-card">vasa</a> on <a href="https://medium.com/p/1edb04f9dc5"><time class="dt-published" datetime="2018-07-31T02:21:01.727Z">July 31, 2018</time></a>.</p><p><a href="https://medium.com/@vaibhavsaini_67863/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 19, 2019.</p></footer></article></body></html>