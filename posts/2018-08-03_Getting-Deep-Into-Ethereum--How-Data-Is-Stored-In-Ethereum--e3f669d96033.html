<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Getting Deep Into Ethereum: How Data Is Stored In Ethereum?</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Getting Deep Into Ethereum: How Data Is Stored In Ethereum?</h1>
</header>
<section data-field="subtitle" class="p-summary">
In this post, we will see how states and transactions are stored in Ethereum and how it is different from Bitcoin.
</section>
<section data-field="body" class="e-content">
<section name="bd9e" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b383" id="b383" class="graf graf--h3 graf--leading graf--title">Getting Deep Into Ethereum: How Data Is Stored In Ethereum?</h3><h4 name="c2c6" id="c2c6" class="graf graf--h4 graf-after--h3 graf--subtitle">In this post, we will see how states and transactions are stored in Ethereum and how it is different from Bitcoin.</h4></div><div class="section-inner sectionLayout--fullWidth"><figure name="f09b" id="f09b" class="graf graf--figure graf--layoutFillWidth graf-after--h4"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 62.5%;"></div><img class="graf-image" data-image-id="0*0RKD7MNS0ZDKjjYl.jpg" data-width="1280" data-height="800" src="https://cdn-images-1.medium.com/max/2560/0*0RKD7MNS0ZDKjjYl.jpg"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="64aa" id="64aa" class="graf graf--p graf-after--figure">This post is a continuation of my <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Getting Deep Into Series </em></strong>started in an effort to provide a deeper understanding of the internal workings and other cool stuff about Ethereum and blockchain in general which you will not find easily on the web. Here are the other parts of the Series:</p><div name="a62a" id="a62a" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://hackernoon.com/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5" data-href="https://hackernoon.com/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5"><strong class="markup--strong markup--mixtapeEmbed-strong">Getting Deep Into Geth: Why Syncing Ethereum Node Is Slow</strong><br><em class="markup--em markup--mixtapeEmbed-em">Downloading the blocks is just a small part. There is a lot of stuff going on... This post marks the first in a new…</em>hackernoon.com</a><a href="https://hackernoon.com/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e6a97393590d492757cceda7711073a5" data-thumbnail-img-id="0*mzGhclFkXu502wAn" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*mzGhclFkXu502wAn);"></a></div><div name="0a11" id="0a11" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015" data-href="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015"><strong class="markup--strong markup--mixtapeEmbed-strong">Getting Deep Into EVM: How Ethereum Works Backstage</strong><br><em class="markup--em markup--mixtapeEmbed-em">An Ultimate, In-depth Explanation of What EVM is and How EVM Works.</em>hackernoon.com</a><a href="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="7fe661788850a5cd9ed94f381f2bbb28" data-thumbnail-img-id="0*JVkzAAwmrQxlktQ_.jpg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*JVkzAAwmrQxlktQ_.jpg);"></a></div><p name="a8bf" id="a8bf" class="graf graf--p graf-after--mixtapeEmbed">In this post, we will dive into Ethereum’s data storage layer. We will introduce the concept of blockchain “state”. We will cover the theory behind the Patricia Trie data structure and demonstrate Ethereum’s concrete implementation of tries using Google’s leveldb database.</p><h3 name="af37" id="af37" class="graf graf--h3 graf-after--p">What do we store in the storage layer?</h3><p name="86e9" id="86e9" class="graf graf--p graf-after--h3">First of all, we have to see that what all things we need to store for making the blockchain system work. Let’s take a simple example of Alice giving Bob 10$.</p><figure name="68c6" id="68c6" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 481px; max-height: 240px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 49.9%;"></div><img class="graf-image" data-image-id="1*fLjE6g-m_YTTXTXqLnpA0w.png" data-width="481" data-height="240" src="https://cdn-images-1.medium.com/max/800/1*fLjE6g-m_YTTXTXqLnpA0w.png"></div></figure><p name="1ad6" id="1ad6" class="graf graf--p graf-after--figure">As we can see here that we can change the state by executing a transaction on it.</p><p name="6a75" id="6a75" class="graf graf--p graf-after--p">Here we have to keep track of the balances and other details of different people(<strong class="markup--strong markup--p-strong">states</strong>) and the details of what happens between them on blockchain(<strong class="markup--strong markup--p-strong">transactions</strong>). Different platforms handle this differently. Here we will see how Bitcoin and Ethereum handle this.</p><h3 name="1b12" id="1b12" class="graf graf--h3 graf-after--p">Bitcoin</h3><p name="d084" id="d084" class="graf graf--p graf-after--h3">Bitcoin’s “state” is represented by its global collection of Unspent Transaction Outputs (UTXOs). The transfer of value in bitcoin is actioned through transactions. More specifically, a bitcoin user can spend one or more of their UTXOs by creating a transaction and adding one or more of their UTXOs as the transaction’s input.</p><p name="d35a" id="d35a" class="graf graf--p graf-after--p">This model of UTXO makes Bitcoin different from Ethereum. Let’s see some examples to understand the difference.</p><p name="517d" id="517d" class="graf graf--p graf-after--p">Firstly, bitcoin UTXOs cannot be partially spent. If a bitcoin user spends 0.5 bitcoin (using their only UTXO which is worth 1 bitcoin) they have to deliberately self-address (send themselves) 0.5 bitcoin in return change. If they don’t send themselves change, they will lose the 0.5 bitcoin change to the bitcoin miner who mines their transaction.</p><figure name="2a4e" id="2a4e" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 602px; max-height: 437px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 72.6%;"></div><img class="graf-image" data-image-id="1*8ckJdAnUMNNd190LNJLz7Q.png" data-width="602" data-height="437" src="https://cdn-images-1.medium.com/max/800/1*8ckJdAnUMNNd190LNJLz7Q.png"></div><figcaption class="imageCaption">UTXO transaction</figcaption></figure><p name="f68c" id="f68c" class="graf graf--p graf-after--figure">Secondly, at the most fundamental level, bitcoin does not maintain user account balances. With bitcoin, a user simply holds the private keys to one or more UTXO at any given point in time. <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Digital wallets make it seem like the bitcoin blockchain automatically stores and organizes user account balances and so forth. This is not the case.</em></strong></p><figure name="b6eb" id="b6eb" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 403px; max-height: 321px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 79.7%;"></div><img class="graf-image" data-image-id="1*0doOO9uDGB3yqfPnsUrAEA.png" data-width="403" data-height="321" src="https://cdn-images-1.medium.com/max/800/1*0doOO9uDGB3yqfPnsUrAEA.png"></div><figcaption class="imageCaption">A visualization of how wallets work in bitcoin</figcaption></figure><p name="d242" id="d242" class="graf graf--p graf-after--figure">The UTXO system in bitcoin works well, in part, due to the fact that digital wallets are able to facilitate most of the tasks associated with transactions. Including but not limited to:</p><p name="10c7" id="10c7" class="graf graf--p graf-after--p">a) handling UTXOs</p><p name="e4f9" id="e4f9" class="graf graf--p graf-after--p">b) storing keys</p><p name="664f" id="664f" class="graf graf--p graf-after--p">c) setting transaction fees</p><p name="f99b" id="f99b" class="graf graf--p graf-after--p">d) providing return change addresses</p><p name="2eae" id="2eae" class="graf graf--p graf-after--p">e) aggregating UTXOs (to show available, pending and total balances)</p><p name="22ea" id="22ea" class="graf graf--p graf-after--p">One analogy for the transactions in the UTXO model is paper bills (banknotes). Each account keeps track of how much money it has by adding up the number of bills (UTXOs) in the purse (associated with this address/wallet). When we want to spend money, we use one or more bills (existing UTXOs), enough to cover the cost and maybe receive some change back (new UTXO). Each bill can only be spent once since, once spent, the UTXO is removed from the pool.</p><p name="dd26" id="dd26" class="graf graf--p graf-after--p">To summarize, we know that:</p><ul class="postList"><li name="4625" id="4625" class="graf graf--li graf-after--p">the bitcoin blockchain does not hold account balances</li><li name="dcf5" id="dcf5" class="graf graf--li graf-after--li">bitcoin <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch05.asciidoc#wallet-technology-overview" data-href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch05.asciidoc#wallet-technology-overview" class="markup--anchor markup--li-anchor" rel="nofollow noopener noopener" target="_blank">wallets hold keys</a> to UTXOs</li><li name="d546" id="d546" class="graf graf--li graf-after--li">if included in a transaction, an entire UTXO is spent (in some cases partially received back as “change” in the form of a brand new UTXO)</li></ul><h3 name="e46d" id="e46d" class="graf graf--h3 graf-after--li">Ethereum</h3><p name="3a3f" id="3a3f" class="graf graf--p graf-after--h3">In contrast to the information above, the Ethereum world state is able to manage account balances, and more. The state of Ethereum is not an abstract concept. It is part of Ethereum’s base layer protocol. As the yellow paper mentions, Ethereum is a transaction-based “state” machine; a technology on which all transaction-based state machine concepts may be built.</p><p name="ac36" id="ac36" class="graf graf--p graf-after--p">Let’s start at the beginning. As with all other blockchains, the Ethereum blockchain begins life at its own genesis block. From this point (genesis state at block 0) onward, activities such as transactions, contracts, and mining will continually change the state of the Ethereum blockchain. In Ethereum, an example of this would be an account balance (stored in the state trie) which changes every time a transaction, in relation to that account, takes place.</p><p name="e30e" id="e30e" class="graf graf--p graf-after--p">Importantly, data such as account balances are not stored directly in the blocks of the Ethereum blockchain. Only the root node hashes of the transaction trie, state trie and receipts trie are stored directly in the blockchain. This is illustrated in the diagram below.</p><figure name="8a20" id="8a20" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 529px; max-height: 523px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 98.9%;"></div><img class="graf-image" data-image-id="1*f0vOn0lRgrY5NjFlbUMBFg.jpeg" data-width="529" data-height="523" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*f0vOn0lRgrY5NjFlbUMBFg.jpeg"></div><figcaption class="imageCaption"><a href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" data-href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" class="markup--anchor markup--figure-anchor" target="_blank">Source</a></figcaption></figure><p name="b908" id="b908" class="graf graf--p graf-after--figure">You will also notice, from the above diagram, that the root node hash of the storage trie (where all of the smart contract data is kept) actually points to the state trie, which in turn points to the blockchain. We will zoom in and cover all of this in more detail soon.</p><p name="f3ee" id="f3ee" class="graf graf--p graf-after--p">There are two vastly different types of data in Ethereum; permanent data and ephemeral data. An example of permanent data would be a transaction. Once a transaction has been fully confirmed, it is recorded in the transaction trie; it is never altered. An example of ephemeral data would be the balance of a particular Ethereum account address. The balance of an account address is stored in the state trie and is altered whenever transactions against that particular account occur. It makes sense that permanent data, like mined transactions, and ephemeral data, like account balances, should be stored separately. Ethereum uses trie data structures to manage data.</p><p name="6994" id="6994" class="graf graf--p graf-after--p">The record-keeping for Ethereum is just like that in a bank. An analogy is using an ATM/debit card. The bank tracks how much money each debit card has, and when we need to spend money, the bank checks its record to make sure we have enough balance before approving the transaction.</p><h3 name="a135" id="a135" class="graf graf--h3 graf-after--p">A Comparison between UTXO and Account approach</h3><p name="0098" id="0098" class="graf graf--p graf-after--h3">The benefits of the UTXO Model:</p><ul class="postList"><li name="1777" id="1777" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Scalability</em></strong> — Since it is possible to process multiple UTXOs at the same time, it enables parallel transactions and encourages scalability innovation.</li><li name="0535" id="0535" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Privacy</em></strong> — Even Bitcoin is not a completely anonymous system, but UTXO provides a higher level of privacy, as long as the users use new addresses for each transaction. If there is a need for enhanced privacy, more complex schemes, such as ring signatures, can be considered.</li></ul><p name="351a" id="351a" class="graf graf--p graf-after--li">The benefits of the Account/Balance Model:</p><ul class="postList"><li name="408b" id="408b" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Simplicity</em></strong> — Ethereum opted for a more intuitive model for the benefit of developers of complex smart contracts, especially those that require state information or involve multiple parties. An example is a smart contract that keeps track of states to perform different tasks based on them. UTXO’s stateless model would force transactions to include state information, and this unnecessarily complicates the design of the contracts.</li><li name="f426" id="f426" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Efficiency</em></strong> — In addition to simplicity, the Account/Balance Model is more efficient, as each transaction only needs to validate that the sending account has enough balance to pay for the transaction.</li></ul><p name="86ac" id="86ac" class="graf graf--p graf-after--li">One drawback for the Account/Balance Model is the exposure to double spending attacks. An incrementing nonce can be implemented to counteract this type of attack. In Ethereum, every account has a public viewable nonce and every time a transaction is made, the nonce is increased by one. This can prevent the same transaction being submitted more than once. (Note, this nonce is different from the Ethereum proof of work nonce, which is a random value.)</p><p name="1646" id="1646" class="graf graf--p graf-after--p">Like most things in computer architecture, both models have trade-offs. Some blockchains, notably Hyperledger, adopt UTXO because they can benefit from the innovation derived from the Bitcoin blockchain. We will look into more technologies that are built on top of these two record-keeping models.</p><h3 name="1c5b" id="1c5b" class="graf graf--h3 graf-after--p">A closer look at the trie structure in Ethereum</h3><p name="0246" id="0246" class="graf graf--p graf-after--h3">Let’s look at the state, storage and transaction tries in a bit more depth.</p><h4 name="9181" id="9181" class="graf graf--h4 graf-after--p">State trie — the one and only</h4><p name="d63f" id="d63f" class="graf graf--p graf-after--h4">There is one, and one only, global state trie in Ethereum.</p><p name="c33e" id="c33e" class="graf graf--p graf-after--p">This global state trie is constantly updated.</p><p name="1640" id="1640" class="graf graf--p graf-after--p">The state trie contains a key and value pair for every account which exists on the Ethereum network.</p><p name="4189" id="4189" class="graf graf--p graf-after--p">The “key” is a single 160 bit identifier (the address of an Ethereum account).</p><p name="2837" id="2837" class="graf graf--p graf-after--p">The “value” in the global state trie is created by encoding the following account details of an Ethereum account (using the Recursive-Length Prefix encoding (RLP) method):<br>- nonce<br>- balance<br>- storageRoot<br>- codeHash</p><p name="693d" id="693d" class="graf graf--p graf-after--p">The state trie’s root node ( a hash of the entire state trie at a given point in time) is used as a secure and unique identifier for the state trie; the state trie’s root node is cryptographically dependent on all internal state trie data.</p><figure name="d4b3" id="d4b3" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 292px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.699999999999996%;"></div><img class="graf-image" data-image-id="1*-Q00GpGTphTOtBWPRu1e3g.png" data-width="1109" data-height="463" src="https://cdn-images-1.medium.com/max/800/1*-Q00GpGTphTOtBWPRu1e3g.png"></div><figcaption class="imageCaption">Relationship between the State Trie (leveldb implementation of a Merkle Patricia Trie) and an Ethereum block (<a href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" data-href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" class="markup--anchor markup--figure-anchor" target="_blank">Source</a>)</figcaption></figure><figure name="bf5d" id="bf5d" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 86px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 12.3%;"></div><img class="graf-image" data-image-id="1*NFM4Cb5eJdzJXvj9-dUorg.png" data-width="1071" data-height="132" src="https://cdn-images-1.medium.com/max/800/1*NFM4Cb5eJdzJXvj9-dUorg.png"></div><figcaption class="imageCaption">State Trie — Keccak-256-bit hash of the state trie’s root node stored as the “stateRoot” value in a given block. stateRoot: ‘0x8c77785e3e9171715dd34117b047dffe44575c32ede59bde39fbf5dc074f2976’ (<a href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" data-href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" class="markup--anchor markup--figure-anchor" target="_blank">Source</a>)</figcaption></figure><h4 name="a888" id="a888" class="graf graf--h4 graf-after--figure">Storage trie — where the contract data lives</h4><p name="a6b4" id="a6b4" class="graf graf--p graf-after--h4">A storage trie is where all of the contract data lives. Each Ethereum account has its own storage trie. A 256-bit hash of the storage trie’s root node is stored as the storageRoot value in the global state trie (which we just discussed).</p><figure name="57bf" id="57bf" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 342px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 48.9%;"></div><img class="graf-image" data-image-id="1*9AvbCSNqn5m9z0qhWjE6cg.png" data-width="867" data-height="424" src="https://cdn-images-1.medium.com/max/800/1*9AvbCSNqn5m9z0qhWjE6cg.png"></div><figcaption class="imageCaption"><a href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" data-href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" class="markup--anchor markup--figure-anchor" target="_blank">Source</a></figcaption></figure><h4 name="3422" id="3422" class="graf graf--h4 graf-after--figure">Transaction trie — one per block</h4><p name="7356" id="7356" class="graf graf--p graf-after--h4">Each Ethereum block has its own separate transaction trie. A block contains many transactions. The order of the transactions in a block are of course decided by the miner who assembles the block. The path to a specific transaction in the transaction trie, is via (the RLP encoding of) the index of where the transaction sits in the block. Mined blocks are never updated; the position of the transaction in a block is never changed. This means that once you locate a transaction in a block’s transaction trie, you can return to the same path over and over to retrieve the same result.</p><figure name="37d0" id="37d0" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 161px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 23%;"></div><img class="graf-image" data-image-id="1*dWv4-5OQoa52QE03G9Qkwg.png" data-width="900" data-height="207" src="https://cdn-images-1.medium.com/max/800/1*dWv4-5OQoa52QE03G9Qkwg.png"></div><figcaption class="imageCaption"><a href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" data-href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" class="markup--anchor markup--figure-anchor" target="_blank">Source</a></figcaption></figure><h3 name="7f44" id="7f44" class="graf graf--h3 graf-after--figure">Concrete examples of tries in Ethereum</h3><p name="9ff0" id="9ff0" class="graf graf--p graf-after--h3">The main Ethereum clients use two different database software solutions to store their tries. Ethereum’s Rust client Parity uses rocksdb. Whereas Ethereum’s Go, C++ and Python clients all use leveldb.</p><h4 name="f44f" id="f44f" class="graf graf--h4 graf-after--p">Ethereum and rocksdb</h4><p name="e821" id="e821" class="graf graf--p graf-after--h4">Rocksdb is out of scope for this post. This may be covered at a later date, but for now, let’s explore how 3 out of the 4 major Ethereum clients utilize leveldb.</p><h4 name="6900" id="6900" class="graf graf--h4 graf-after--p">Ethereum and leveldb</h4><p name="e672" id="e672" class="graf graf--p graf-after--h4">LevelDB is an open source Google key-value storage library which provides, amongst other things, forward and backward iterations over data, ordered mapping from string keys to string values, custom comparison functions and automatic compression. The data is automatically compressed using “Snappy” an open source Google compression/decompression library. Whilst Snappy does not aim for maximum compression, it aims for very high speeds. Leveldb is an important storage and retrieval mechanism which manages the state of the Ethereum network. As such, leveldb is a dependency for the most popular Ethereum clients (nodes) such as go-ethereum, cpp-ethereum and pyethereum.</p><blockquote name="2438" id="2438" class="graf graf--blockquote graf-after--p">Whilst the implementation of the trie data structure can be done on disk (using database software such as leveldb) it is important to note that there is a difference between traversing a trie and simply looking at the flat key/value database.</blockquote><p name="fbcf" id="fbcf" class="graf graf--p graf-after--blockquote">To learn more, we have to access the data in leveldb using the appropriate Patricia trie libraries. To do this we will need an Ethereum installation.</p><p name="9687" id="9687" class="graf graf--p graf-after--p">Here is a easy to follow tutorial for setting up your own Ethereum private network.</p><div name="558f" id="558f" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f" data-href="https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f"><strong class="markup--strong markup--mixtapeEmbed-strong">How To: Create Your Own Private Ethereum Blockchain</strong><br><em class="markup--em markup--mixtapeEmbed-em">Dev highlights of this week</em>medium.com</a><a href="https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="77c4d0f6e33fd422e1298a3fb66e82bb" data-thumbnail-img-id="1*tBaiZrAVBW6XyXcM5nHIkg.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*tBaiZrAVBW6XyXcM5nHIkg.png);"></a></div><p name="0d6e" id="0d6e" class="graf graf--p graf-after--mixtapeEmbed">Once you have set up your Ethereum private network, you will be able to execute transactions and explore how Ethereum’s “state” responds to network activities such as transactions, contracts and mining. If you are not in a position to install an Ethereum private network, that’s OK. We will provide our code examples and screen captures from our Ethereum private network.</p><h3 name="e190" id="e190" class="graf graf--h3 graf-after--p">Analysing the Ethereum database</h3><p name="1485" id="1485" class="graf graf--p graf-after--h3">As we mentioned previously there are many Merkle Patricia Tries (referenced in <strong class="markup--strong markup--p-strong">each</strong> block) within the Ethereum blockchain:</p><ul class="postList"><li name="5ddf" id="5ddf" class="graf graf--li graf-after--p">State Trie</li><li name="6f97" id="6f97" class="graf graf--li graf-after--li">Storage Trie</li><li name="b08a" id="b08a" class="graf graf--li graf-after--li">Transaction Trie</li><li name="a742" id="a742" class="graf graf--li graf-after--li">Receipts Trie</li></ul><p name="0da1" id="0da1" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">The following sections assume that you have </em></strong><a href="https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f" data-href="https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f" class="markup--anchor markup--p-anchor" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">installed and configured your very own Ethereum private network</em></strong></a><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">, or that you are happy to just follow along as we run some software and talk to Ethereum’s leveldb database.</em></strong></p><p name="85a0" id="85a0" class="graf graf--p graf-after--p">To reference a particular Merkle Patricia Trie in a particular block we need to obtain its root hash, as a reference. The following commands allow us to obtain the root hashes of the state, transaction and receipt tries in the genesis block.</p><figure name="727e" id="727e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/vasa-develop/d628844015d171cd7dd05ec288ab3d50.js"></script></figure><figure name="6c9a" id="6c9a" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 74px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 10.6%;"></div><img class="graf-image" data-image-id="1*IbnRm4TYAY55u7Ax2ZL_6A.png" data-width="1120" data-height="119" src="https://cdn-images-1.medium.com/max/800/1*IbnRm4TYAY55u7Ax2ZL_6A.png"></div></figure><p name="23bc" id="23bc" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Note:</strong> If you would like the root hashes of the <strong class="markup--strong markup--p-strong">latest</strong> block (instead of the genesis block), please use the following command.</p><figure name="5246" id="5246" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/vasa-develop/6faa9579dacae9f5d3bfd90bbe505a4a.js"></script></figure><h4 name="a1a7" id="a1a7" class="graf graf--h4 graf-after--figure">Installing npm, node, level and ethereumjs</h4><p name="effe" id="effe" class="graf graf--p graf-after--h4">We will be using a combination of nodejs, level and <a href="https://github.com/ethereumjs/ethereumjs-vm" data-href="https://github.com/ethereumjs/ethereumjs-vm" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">ethereumjs</a> (which implements Ethereum’s VM in Javascript) to inspect the leveldb database. The following commands will further prepare our environment.</p><figure name="1a6c" id="1a6c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/vasa-develop/e0959e14cdb069dbb410b1a5e6c56abc.js"></script></figure><p name="e010" id="e010" class="graf graf--p graf-after--figure">From this point, running the following code will print a list of the Ethereum account keys (which are stored in the state root of your Ethereum private network). The code connects to Ethereum’s leveldb database, enters Ethereum’s world state (using a stateRoot value from a block in the blockchain) and then accesses the keys to all accounts on the Ethereum private network.</p><figure name="8ef3" id="8ef3" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/vasa-develop/42edd77af2f40b2ac3e90d7c0873d7b8.js"></script></figure><figure name="24ec" id="24ec" class="graf graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 36px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 5.2%;"></div><img class="graf-image" data-image-id="1*zEIgr2MNmtt_OWGpPe1NJg.png" data-width="1097" data-height="57" src="https://cdn-images-1.medium.com/max/800/1*zEIgr2MNmtt_OWGpPe1NJg.png"></div><figcaption class="imageCaption">Output for the above code</figcaption></figure><blockquote name="2ae8" id="2ae8" class="graf graf--blockquote graf-after--figure">Interestingly, accounts in Ethereum are only added to the state trie once a transaction has taken place (in relation to that specific account). For example, just creating a new account using “geth account new” will not include that account in the state trie; even after many blocks have been mined. However, if a successful transaction (one which costs gas <strong class="markup--strong markup--blockquote-strong">and</strong> is included in a mined block) is recorded against that account, then and only then will that account appear in the state trie. This is clever logic which protects against malicious attackers continuously creating new accounts and bloating the state trie.</blockquote><h4 name="681e" id="681e" class="graf graf--h4 graf-after--blockquote">Decoding the data</h4><p name="15d9" id="15d9" class="graf graf--p graf-after--h4">You will have noticed that querying leveldb returns encoded results. This is due to the fact that Ethereum uses its own specially “Modified Merkle Patricia Trie” implementation when interacting with leveldb. The Ethereum Wiki provides information in relation to the design and implementation of both Ethereum’s <a href="https://github.com/ethereum/wiki/wiki/Patricia-Tree" data-href="https://github.com/ethereum/wiki/wiki/Patricia-Tree" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">Modified Merkle Patricia Trie</a> and <a href="https://github.com/ethereum/wiki/wiki/RLP" data-href="https://github.com/ethereum/wiki/wiki/RLP" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">Recursive Length Prefix (RLP) encoding</a>. In short, Ethereum have extended on the trie data structures. For example the Modified Merkle Patricia contains a method which can shortcut the descent (down the trie) through the use of an “extension” node.</p><p name="3e6b" id="3e6b" class="graf graf--p graf-after--p">In Ethereum, a single Modified Merkle Patricia trie node is either:</p><ul class="postList"><li name="90e6" id="90e6" class="graf graf--li graf-after--p">an empty string (referred to as NULL)</li><li name="ed79" id="ed79" class="graf graf--li graf-after--li">an array which contains 17 items (referred to as a branch)</li><li name="2620" id="2620" class="graf graf--li graf-after--li">an array which contains 2 items (referred to as a leaf)</li><li name="bad6" id="bad6" class="graf graf--li graf-after--li">an array which contains 2 items (referred to as an extension)</li></ul><p name="81af" id="81af" class="graf graf--p graf-after--li">As Ethereum’s tries are designed and constructed with rigid rules, the best way to inspection them is through the use of computer code. The following example uses ethereumjs. The ethereumjs repositories are easy to install and use; they will be perfect for us to quickly peer into Ethereum leveldb database.</p><p name="dc4a" id="dc4a" class="graf graf--p graf-after--p">The code below (when provided with a particular block’s stateRoot as well as an Ethereum account address) will return that account’s correct balance in a human readable form.</p><figure name="5be8" id="5be8" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 30px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 4.3%;"></div><img class="graf-image" data-image-id="1*xioZ7tF-WJ1cu2XomZjPog.png" data-width="924" data-height="40" src="https://cdn-images-1.medium.com/max/800/1*xioZ7tF-WJ1cu2XomZjPog.png"></div><figcaption class="imageCaption">Output from the following code (account balance for address <code class="markup--code markup--figure-code">0xccc6b46fa5606826ce8c18fece6f519064e6130b)</code></figcaption></figure><figure name="cf86" id="cf86" class="graf graf--figure graf--iframe graf-after--figure"><script src="https://gist.github.com/vasa-develop/004c74f71f020d981709292cb5675f1b.js"></script></figure><h3 name="6125" id="6125" class="graf graf--h3 graf-after--figure">Conclusion</h3><p name="75db" id="75db" class="graf graf--p graf-after--h3">We have demonstrated above that Ethereum has the ability to manage its “state”. This clever upfront design has many advantages.</p><h4 name="5dfc" id="5dfc" class="graf graf--h4 graf-after--p">Mobility</h4><p name="8ce3" id="8ce3" class="graf graf--p graf-after--h4">Given that mobile devices and Internet of Things (IoT) devices are now ubiquitous, the future of e-commerce depends on safe, robust and fast mobile applications.</p><figure name="bd33" id="bd33" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 465px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 66.4%;"></div><img class="graf-image" data-image-id="1*LUDKKtihxxLFpjz80zf0ag.jpeg" data-width="1024" data-height="680" src="https://cdn-images-1.medium.com/max/800/1*LUDKKtihxxLFpjz80zf0ag.jpeg"></div></figure><p name="e4f8" id="e4f8" class="graf graf--p graf-after--figure">As we acknowledge advances in mobility, we also acknowledge that the constant increase in blockchain size is inevitable. It is not practicable to store entire blockchains on everyday mobile devices.</p><h4 name="8417" id="8417" class="graf graf--h4 graf-after--p">Speed, without compromising security</h4><p name="8b58" id="8b58" class="graf graf--p graf-after--h4">The design of Ethereum’s world state and its use of the Modified Merkle Patricia Trie provides many opportunities in this space. Every function (put, update and delete) performed on a trie in Ethereum utilizes a deterministic cryptographic hash. Further, the unique cryptographic hash of a trie’s root node can be used as evidence that the trie has not been tampered with.</p><p name="703c" id="703c" class="graf graf--p graf-after--p">For example any changes to a trie’s data, at any level (such as increasing an accounts balance in the leveldb database) will completely change the root hash. This cryptographic feature provides an opportunity for light clients (devices which do not store the entire blockchain) to quickly and reliably query the blockchain i.e. does account “0x … 4857” have enough funds to complete this purchase at block height “5044866”?</p><blockquote name="0d8b" id="0d8b" class="graf graf--blockquote graf--startsWithDoubleQuote graf-after--p">“The size complexity of a Merkle proof is logarithmic in the quantity of data stored. This means that, even if the entire state tree is a few gigabytes in size, if a node receives a state root from a trusted source that node has the ability to know with full certainty the validity of any information with the tree by only downloading a few kilobytes of data in a proof.”</blockquote><h4 name="a0e2" id="a0e2" class="graf graf--h4 graf-after--blockquote">Spend limits</h4><p name="bc66" id="bc66" class="graf graf--p graf-after--h4">An interesting idea, mentioned in the Ethereum white paper is the notion of a savings account. In this scenario two users (perhaps a husband and wife, or business partners) can each withdraw 1% of the accounts total balance per day. This idea is only mentioned in the “further applications” section of the white paper, but it sparks interest because of the fact that, in theory, it could be implemented as part of Ethereum’s base protocol layer (as apposed to having to be written as part of a second layer solution or third-party wallet). You may recall our discussion about bitcoin UTXOs at the start of this article. UTXOs are blind to blockchain data, and as we discussed, the bitcoin blockchain does not actually store a users account balance. For this reason the base protocol layer of bitcoin is far less likely (or perhaps unable to) implement any sort of daily spend limits.</p><h4 name="6ce6" id="6ce6" class="graf graf--h4 graf-after--p">Consumer confidence</h4><p name="453a" id="453a" class="graf graf--p graf-after--h4">As work continues in this space we will see a lot of development in light clients. More specifically, safe, robust and fast mobile applications, which can interact with blockchain technologies.</p><figure name="d2a4" id="d2a4" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 455px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 64.9%;"></div><img class="graf-image" data-image-id="1*I-fz7QPeEHWtEk6BKW-rVA.jpeg" data-width="1024" data-height="665" src="https://cdn-images-1.medium.com/max/800/1*I-fz7QPeEHWtEk6BKW-rVA.jpeg"></div></figure><p name="d785" id="d785" class="graf graf--p graf-after--figure graf--trailing">A successful blockchain implementation in the e-commerce space must bolster speed, safety and usability. It is always possible to improve consumer confidence as well as increase mainstream adoption by providing superior usability, safety and performance through smart design.</p></div></div></section><section name="a5a5" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="9570" id="9570" class="graf graf--p graf--leading graf--trailing">Thanks to <a href="https://medium.com/@timmccallum" data-href="https://medium.com/@timmccallum" class="markup--anchor markup--p-anchor" target="_blank">Timothy McCallum</a> for his wonderful explanation on <a href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" data-href="https://medium.com/cybermiles/diving-into-ethereums-world-state-c893102030ed" class="markup--anchor markup--p-anchor" target="_blank">states in Ethereum</a>.</p></div></div></section><section name="87e2" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="9551" id="9551" class="graf graf--p graf--leading">Thanks for reading ;)</p><h4 name="3073" id="3073" class="graf graf--h4 graf-after--p">Learned something? Press and hold the 👏 to say “thanks!” and help others find this article.</h4><p name="abe6" id="abe6" class="graf graf--p graf-after--h4"><em class="markup--em markup--p-em">Hold down the clap button if you liked the content! It helps me gain exposure .</em></p><p name="3a73" id="3a73" class="graf graf--p graf-after--p">Want to learn more? Checkout my previous articles.</p><div name="679d" id="679d" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148" data-href="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148"><strong class="markup--strong markup--mixtapeEmbed-strong">HackPedia: 16 Solidity Hacks/Vulnerabilities, their Fixes and Real World Examples</strong><br><em class="markup--em markup--mixtapeEmbed-em">A Complete List of all Solidity Hacks/Vulnerabilities, their Fixes and Real World Hack Examples</em>hackernoon.com</a><a href="https://hackernoon.com/hackpedia-16-solidity-hacks-vulnerabilities-their-fixes-and-real-world-examples-f3210eba5148" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="b42587cd10179acb6cbe0e49c3ba97ad" data-thumbnail-img-id="1*cgEAk9Z51Qi39saBRCJ1Pg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*cgEAk9Z51Qi39saBRCJ1Pg.jpeg);"></a></div><div name="1cb3" id="1cb3" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" data-href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f"><strong class="markup--strong markup--mixtapeEmbed-strong">ConsensusPedia: An Encyclopedia of 30 Consensus Algorithms</strong><br><em class="markup--em markup--mixtapeEmbed-em">A complete list of all consensus algorithms.</em>hackernoon.com</a><a href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="03bbca255c9ab55c0112e7879627edb3" data-thumbnail-img-id="0*y462aeJ4wg8HHYSs" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*y462aeJ4wg8HHYSs);"></a></div><div name="f1ac" id="f1ac" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" data-href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5"><strong class="markup--strong markup--mixtapeEmbed-strong">ContractPedia: An Encyclopedia of 40 Smart Contract Platforms</strong><br><em class="markup--em markup--mixtapeEmbed-em">A Complete List of all Smart Contract supportive Platforms</em>hackernoon.com</a><a href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a949ea9028a00c3bb62dfc3f160efc92" data-thumbnail-img-id="0*zDyDSLiGCSPQHEMq.jpg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*zDyDSLiGCSPQHEMq.jpg);"></a></div><div name="15fe" id="15fe" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" data-href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707"><strong class="markup--strong markup--mixtapeEmbed-strong">Difference between SideChains and State Channels</strong><br><em class="markup--em markup--mixtapeEmbed-em">A complete comparison of the two scaling methods.</em>hackernoon.com</a><a href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="096410b77bc232079dc957910f44555f" data-thumbnail-img-id="1*UmKkLx0_zCrwX1etzE-TRg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*UmKkLx0_zCrwX1etzE-TRg.jpeg);"></a></div><p name="f226" id="f226" class="graf graf--p graf-after--mixtapeEmbed graf--trailing"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Clap 50 times and follow me on Twitter: </em></strong><a href="https://twitter.com/itsmattward" data-href="https://twitter.com/itsmattward" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener nofollow noopener noopener noopener noopener noopener noopener noopener noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">@</em></strong></a><a href="https://twitter.com/vasa_develop" data-href="https://twitter.com/vasa_develop" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener nofollow noopener noopener noopener noopener noopener noopener noopener noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">vasa_develop</em></strong></a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@vaibhavsaini_67863" class="p-author h-card">vasa</a> on <a href="https://medium.com/p/e3f669d96033"><time class="dt-published" datetime="2018-08-03T19:41:01.023Z">August 3, 2018</time></a>.</p><p><a href="https://medium.com/@vaibhavsaini_67863/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 19, 2019.</p></footer></article></body></html>