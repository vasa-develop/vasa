<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>How to Write Upgradable (Versioned) Smart Contracts in Solidity?</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">How to Write Upgradable (Versioned) Smart Contracts in Solidity?</h1>
</header>
<section data-field="subtitle" class="p-summary">
A Complete Guide on Understanding and Implementing Upgradable Smart Contracts in Solidity using Libraries
</section>
<section data-field="body" class="e-content">
<section name="932a" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="d99f" id="d99f" class="graf graf--h3 graf--leading graf--title">How to Write Upgradable (Versioned) Smart Contracts in Solidity?</h3><h4 name="58af" id="58af" class="graf graf--h4 graf-after--h3 graf--subtitle">A Complete Guide on Understanding and Implementing Upgradable Smart Contracts in Solidity using Libraries</h4></div><div class="section-inner sectionLayout--fullWidth"><figure name="0845" id="0845" class="graf graf--figure graf--layoutFillWidth graf-after--h4"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*7w_Vx1hxqfnonDTKka6UsA.jpeg" data-width="1920" data-height="1080" data-is-featured="true" src="https://cdn-images-1.medium.com/max/2560/1*7w_Vx1hxqfnonDTKka6UsA.jpeg"></div><figcaption class="imageCaption">Versioning(Pseudo-Versioning) Smart Contracts</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="98d0" id="98d0" class="graf graf--p graf-after--figure">Immutability is a feature that makes the Blockchain great.</p><p name="5279" id="5279" class="graf graf--p graf-after--p">But like everything in this world, it also does have some cons.</p><p name="aac8" id="aac8" class="graf graf--p graf-after--p">This article focuses on <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Reusability and Upgradeability of Smart Contracts</em></strong> in today‚Äôs Blockchain platforms. We will mainly talk about Ethereum in this article, which is the most widely used smart contract platform today.</p><p name="35d0" id="35d0" class="graf graf--p graf-after--p">But first Go make a cup of coffee‚òï first, it‚Äôs going to be a long one.</p><p name="7eb0" id="7eb0" class="graf graf--p graf-after--p">We will start by seeing what are the reasons behind these restrictions/inabilities of current smart contract platforms. Then we will explore workarounds to model the Upgradeability(versioning) behavior(I call it <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Pseudo-Versioning</em></strong>) which we enjoy today in almost all of the centralized platforms.</p><p name="f0b0" id="f0b0" class="graf graf--p graf-after--p">P.S. <em class="markup--em markup--p-em">If you are really new to EVM(or want to learn about EVM in depth), then consider going through the below article</em>.</p><div name="ebf9" id="ebf9" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015" data-href="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015"><strong class="markup--strong markup--mixtapeEmbed-strong">Getting Deep Into EVM: How Ethereum Works Backstage</strong><br><em class="markup--em markup--mixtapeEmbed-em">An Ultimate, In-depth Explanation of What EVM is and How EVM Works.</em>hackernoon.com</a><a href="https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="7fe661788850a5cd9ed94f381f2bbb28" data-thumbnail-img-id="0*JVkzAAwmrQxlktQ_.jpg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*JVkzAAwmrQxlktQ_.jpg);"></a></div><h3 name="59da" id="59da" class="graf graf--h3 graf-after--mixtapeEmbed">Overview</h3><p name="fa6a" id="fa6a" class="graf graf--p graf-after--h3">Solidity(broadly speaking, EVM) has still a long way to go in terms of programmer productivity and language expressiveness. If you have worked with Ethereum, then by now you have probably realized that</p><blockquote name="bcca" id="bcca" class="graf graf--pullquote graf-after--p">Solidity is a limited language.</blockquote><p name="0ea8" id="0ea8" class="graf graf--p graf-after--pullquote">Especially, when you come from the lands of Swift and Javascript, developing in <strong class="markup--strong markup--p-strong">Solidity</strong> is definitely a step back in terms of what the language allows the programmer to do and the expressiveness of the language.</p><p name="a319" id="a319" class="graf graf--p graf-after--p">This can sometimes, piss you off.</p><figure name="c3d2" id="c3d2" class="graf graf--figure graf--iframe graf-after--p"><iframe src="https://tenor.com/embed/5585294" width="600" height="400" frameborder="0" scrolling="no"></iframe><figcaption class="imageCaption">Even the Panda got pissed off</figcaption></figure><h3 name="03f5" id="03f5" class="graf graf--h3 graf-after--figure">But Why it is¬†Limited?</h3><p name="eccb" id="eccb" class="graf graf--p graf-after--h3">Solidity, and in general languages that compile to bytecode intended to be executed in the EVM(which is a sandboxed), are limited because:</p><ul class="postList"><li name="cc92" id="cc92" class="graf graf--li graf-after--p">When executed, your code will run on <strong class="markup--strong markup--li-strong">every node</strong> of the network. Once a node receives a new block, it will <strong class="markup--strong markup--li-strong">verify its integrity</strong>. In Ethereum this also means verifying that all the computations that happened on that block were performed correctly and the new state of contracts is correct.</li><li name="da07" id="da07" class="graf graf--li graf-after--li">This causes that, even though the EVM is Turing-complete, heavy computations are <strong class="markup--strong markup--li-strong">expensive</strong> (or directly not allowed by the current gas limit) because every node will need to perform it, therefore slowing the network.</li><li name="3b53" id="3b53" class="graf graf--li graf-after--li">A standard library hasn‚Äôt really been developed yet. Arrays and strings are especially painful, I have personally had to implement my own <a href="https://hackernoon.com/serializing-string-arrays-in-solidity-db4b6037e520" data-href="https://hackernoon.com/serializing-string-arrays-in-solidity-db4b6037e520" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">string manipulation library</a> in order to do basic stuff, that we take for granted otherwise.</li><li name="e837" id="e837" class="graf graf--li graf-after--li">You cannot get data from the outside world (out of the EVM) unless it gets in via a transaction (Oracle) and once a contract is deployed it is not upgradable (you can plan for migrations or pure storage contracts, though).</li></ul><p name="fd23" id="fd23" class="graf graf--p graf-after--li">Some of this limitations are needed for the existence of the Ethereum computing platform (you will never be able to store a backup of your Google Photos and perform image recognition purely on-chain, and that is just fine). Other limitations are here just because it is a really young technology (though evolving blazingly fast) and it will keep improving over time.</p><h3 name="f401" id="f401" class="graf graf--h3 graf-after--p">Ok. But how the F**k do I solve this¬†problem?</h3><p name="180c" id="180c" class="graf graf--p graf-after--h3">While working on a project, which needed changes in the contracts in future, I came across ‚Äúlibrary‚Äù. This is a feature of Solidity which helps us to solve(indirectly) this problem. Before going into the Upgradable contract implementation, let‚Äôs see what is it and it‚Äôs limitations.</p><h3 name="f812" id="f812" class="graf graf--h3 graf-after--p">What are libraries and Why do we Need¬†them?</h3><p name="b8df" id="b8df" class="graf graf--p graf-after--h3">In Solidity, a library is a different type of contract, that doesn‚Äôt have any storage and cannot hold ether. Sometimes it is helpful to think of a library as a <strong class="markup--strong markup--p-strong">singleton</strong> in the EVM, a piece of code that can be called from any contract without the need to deploy it again. <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">This solves some big problems</em></strong> like:</p><ul class="postList"><li name="1809" id="1809" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Deployment gas costs</em>: </strong>This has the obvious benefit of <strong class="markup--strong markup--li-strong">saving</strong> substantial amounts of <strong class="markup--strong markup--li-strong">gas</strong>, because the same code doesn‚Äôt have to be deployed over and over, and different contracts can just rely on the same already deployed library.</li><li name="9482" id="9482" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Code repetition in the blockchain: </em></strong>This is obvious from the above point.</li><li name="beab" id="beab" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">Code Updates: </em></strong>Earlier bug fixes and updates need to be deployed independently on each project (or, even worse, <a href="http://www.coindesk.com/ethereum-executes-blockchain-hard-fork-return-dao-investor-funds/" data-href="http://www.coindesk.com/ethereum-executes-blockchain-hard-fork-return-dao-investor-funds/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Ethereum has to hard fork to fix a contract‚Äôs problems</a>). Now, it‚Äôs solved.</li></ul><p name="3092" id="3092" class="graf graf--p graf-after--li">Libraries do sound awesome, right? Unfortunately, they also have some limitations. Below are <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">some important things to know about libraries</em></strong>:</p><ul class="postList"><li name="f654" id="f654" class="graf graf--li graf-after--p">Libraries <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">don‚Äôt</em></strong><em class="markup--em markup--li-em"> </em><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">have storage capabilities</em></strong>.</li><li name="144d" id="144d" class="graf graf--li graf-after--li">Libraries <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">can</em></strong> <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">manipulate the storage of other contracts</em></strong>.</li><li name="55da" id="55da" class="graf graf--li graf-after--li">Libraries <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">cannot have payable functions</em></strong>.</li><li name="0b84" id="0b84" class="graf graf--li graf-after--li">Libraries <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">cannot have a fallback function</em></strong>.</li><li name="a503" id="a503" class="graf graf--li graf-after--li">Libraries<strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em"> don‚Äôt have an event log</em></strong>.</li><li name="6a10" id="6a10" class="graf graf--li graf-after--li">Libraries <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">can be used to fire event logs for the contract which uses it</em></strong>.</li><li name="ef56" id="ef56" class="graf graf--li graf-after--li">Libraries <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">aren‚Äôt allowed to inherit</em></strong>.</li><li name="b6e8" id="b6e8" class="graf graf--li graf-after--li">Even though libraries cannot directly inherit, <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">they can be linked with other libraries and use them in the same way a contract would, but with the natural limitations of libraries</em></strong>.</li></ul><p name="2a45" id="2a45" class="graf graf--p graf-after--li">These points can sound confusing at first. Don‚Äôt Panic. Here is a great resource to get your head around libraries.</p><div name="39d5" id="39d5" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/aragondec/library-driven-development-in-solidity-2bebcaf88736" data-href="https://medium.com/aragondec/library-driven-development-in-solidity-2bebcaf88736" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/aragondec/library-driven-development-in-solidity-2bebcaf88736"><strong class="markup--strong markup--mixtapeEmbed-strong">Library Driven Development in Solidity</strong><br><em class="markup--em markup--mixtapeEmbed-em">A comprehensive review on how to develop more modular, reusable and elegant smart contract systems on top of the‚Ä¶</em>medium.com</a><a href="https://medium.com/aragondec/library-driven-development-in-solidity-2bebcaf88736" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="9018e746901f97b1385ddd938bf59010" data-thumbnail-img-id="1*yphB1r5_cSVuzil65_NbNw.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*yphB1r5_cSVuzil65_NbNw.jpeg);"></a></div><p name="c212" id="c212" class="graf graf--p graf-after--mixtapeEmbed">But for now, we will only cover the parts which we need to understand in order to understand/implement upgradable contracts.</p><h3 name="aeea" id="aeea" class="graf graf--h3 graf-after--p">How does a Library¬†work?</h3><p name="35f1" id="35f1" class="graf graf--p graf-after--h3">A library is a type of contract that <em class="markup--em markup--p-em">doesn‚Äôt allow payable functions</em> and <em class="markup--em markup--p-em">cannot have a fallback function</em> (<strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">these limitations are enforced at compile time, therefore making it impossible for a library to hold funds</em></strong>). A library is defined with the keyword library (<code class="markup--code markup--p-code">library L{}</code>) in the same way a contract is defined (<code class="markup--code markup--p-code">contract C{}</code>).</p><figure name="ec4d" id="ec4d" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/vasa-develop/afd71c0da56c422bb824dc604f6f8810.js"></script></figure><p name="3e18" id="3e18" class="graf graf--p graf-after--figure">Calling a function of a library will use a special instruction (<code class="markup--code markup--p-code">DELEGATECALL</code>), that will cause the calling context to be passed to the library as if it was code running in the contract itself. I really like this angle from the Solidity documentation,</p><blockquote name="ca7e" id="ca7e" class="graf graf--blockquote graf--startsWithDoubleQuote graf-after--p">‚ÄúLibraries can be seen as implicit base contracts of the contracts that use them‚Äù</blockquote><p name="e210" id="e210" class="graf graf--p graf-after--blockquote">In the above snippet, when function <code class="markup--code markup--p-code">a()</code> of contract C is called, the <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">address of the contract will be returned and not the library&#39;s</em></strong>. This appears to be the same for all <code class="markup--code markup--p-code">msg</code> properties: <code class="markup--code markup--p-code">msg.sender</code>, <code class="markup--code markup--p-code">msg.value</code>, <code class="markup--code markup--p-code">msg.sig</code>, <code class="markup--code markup--p-code">msg.data</code> and <code class="markup--code markup--p-code">msg.gas</code>. (<a href="https://solidity.readthedocs.io/en/develop/units-and-global-variables.html" data-href="https://solidity.readthedocs.io/en/develop/units-and-global-variables.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Solidity documentation</a> related to this indicates otherwise, but after doing some <a href="https://ethereum.github.io/browser-solidity/#version=soljson-v0.4.8+commit.60cc1668.js&amp;optimize=false&amp;gist=cea2aef4eef10e7f713521f68e571bd6" data-href="https://ethereum.github.io/browser-solidity/#version=soljson-v0.4.8+commit.60cc1668.js&amp;optimize=false&amp;gist=cea2aef4eef10e7f713521f68e571bd6" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">testing</a> it looks like <code class="markup--code markup--p-code">msg</code> context is maintained).</p><p name="d385" id="d385" class="graf graf--p graf-after--p">One thing we can notice here is that it is not clear how class C and library L are linked. So, let‚Äôs see that.</p><h3 name="fff8" id="fff8" class="graf graf--h3 graf-after--p">How are libraries linked?</h3><p name="5eed" id="5eed" class="graf graf--p graf-after--h3">Different from explicit base contract inheritance, (<code class="markup--code markup--p-code">contract C is B {}</code>) in a contract that depends on a library, it is not that clear how a contract gets linked with a library. In the above case, contract C uses library L in its function <code class="markup--code markup--p-code">a()</code>, but there is no mention of what address of the library to use, and L won&#39;t get compiled inside C&#39;s bytecode.</p><p name="ce6e" id="ce6e" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Library linking happens at the bytecode level</em></strong>. When contract C is compiled, it leaves a placeholder for the library address in this way <code class="markup--code markup--p-code">0073__L_____________________________________630dbe671f</code>(<code class="markup--code markup--p-code">0dbe671f</code> is the <a href="https://solidity.readthedocs.io/en/develop/units-and-global-variables.html#block-and-transaction-properties" data-href="https://solidity.readthedocs.io/en/develop/units-and-global-variables.html#block-and-transaction-properties" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">function signature</a> for <code class="markup--code markup--p-code">a()</code>). If we were to deploy contract C untouched, the deployment would fail as the bytecode is invalid.</p><p name="d8b2" id="d8b2" class="graf graf--p graf-after--p graf--trailing"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">In simple words</em></strong>, Library linking is as simple as <strong class="markup--strong markup--p-strong">replacing all</strong> occurrences of the library placeholder in the contract bytecode <strong class="markup--strong markup--p-strong">with the address</strong> of the deployed library in the blockchain. Once the contract is linked to the library, it can be deployed.</p></div></div></section><section name="23e6" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="d303" id="d303" class="graf graf--p graf--leading">Now as we have covered the basics of the library, let‚Äôs see how we can use them to create upgradeable contracts.</p><h3 name="061a" id="061a" class="graf graf--h3 graf-after--p">Library, themselves are not Upgradeable</h3><p name="88ca" id="88ca" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">They are not</em></strong><em class="markup--em markup--p-em">, in the same way, </em><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">contracts aren‚Äôt either</em></strong><em class="markup--em markup--p-em">. </em>As stated in the previous section, <em class="markup--em markup--p-em">the reference to the library is made at the bytecode level rather than at the storage level. </em><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Changing the bytecode of a contract is not allowed once deployed, therefore the reference to the library will live as long as the contract does</em></strong><em class="markup--em markup--p-em">.</em></p><p name="ef1b" id="ef1b" class="graf graf--p graf-after--p">You must be asking that, then how does one introduce the ‚Äúupgradable‚Äù feature that we have been talking about this whole time?</p><h3 name="5aa2" id="5aa2" class="graf graf--h3 graf-after--p">Finally, How it Actually¬†Works?</h3><p name="df4d" id="df4d" class="graf graf--p graf-after--h3">Here is where a little trick comes in. Let‚Äôs see this in detail:</p></div><div class="section-inner sectionLayout--outsetColumn"><figure name="3947" id="3947" class="graf graf--figure graf--layoutOutsetCenter graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 774px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*07eLbMtyPuMHK5BtFBCa2w.png" data-width="1280" data-height="960" src="https://cdn-images-1.medium.com/max/1200/1*07eLbMtyPuMHK5BtFBCa2w.png"></div><figcaption class="imageCaption">Model of Updatable Contract</figcaption></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="0799" id="0799" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Instead of linking the main user-facing contract directly with the address of the deployed library, it is linked to a ‚ÄòDispatcher‚Äô contract</em></strong>. At compile and deploy time this is just fine because the Dispatcher doesn‚Äôt implement any of the methods of the library. This means that as the Dispatcher contract doesn‚Äôt use any library code in the contract itself, it‚Äôs(Dispatcher contract) bytecode(like the bytecode for contract C which we saw above) doesn‚Äôt have to include the library‚Äôs address in its bytecode. So, as we are not hardcoding any address on the bytecode level, we can swap the library any time with a different one.</p><p name="25f4" id="25f4" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">But if we are not using any library code in the Dispatcher contract, then how do we execute the library functions?</em></p><p name="475e" id="475e" class="graf graf--p graf-after--p">When a transaction comes in, the main contract(Token contract) thinks it is making a <code class="markup--code markup--p-code">delegatecall</code> to the library(TokenLib1) it is linked with. But this <code class="markup--code markup--p-code">delegatecall</code> will instead be made to the dispatcher(Dispatcher contract).</p><p name="8eaa" id="8eaa" class="graf graf--p graf-after--p">Here is where things get interesting. Once the dispatcher catches the <code class="markup--code markup--p-code">delegatecall</code> in its <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">fallback function</em></strong> it figures out what the correct version of the library code is, and redirects the call once again with a <code class="markup--code markup--p-code">delegatecall</code>. Once the library returns, the return will go all the way back to the main contract.</p><p name="f2d5" id="f2d5" class="graf graf--p graf-after--p">This solution works great, but it has some minor limitations.</p><h4 name="9da2" id="9da2" class="graf graf--h4 graf-after--p">Limitations</h4><ul class="postList"><li name="affc" id="affc" class="graf graf--li graf-after--h4">The <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">dispatcher needs to know what the memory size for the return of that library call is</em></strong>. Right now it is solved by having a mapping for function signatures to their return type size. This was intentionally kept out of the drawing for the sake of simplicity.</li><li name="5046" id="5046" class="graf graf--li graf-after--li">Given the way <code class="markup--code markup--li-code">delegatecall</code>‚Äôs work on the EVM level, <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">you can only use it from one contract to another that has the same storage footprint</em></strong>. As libraries have no storage, we kept Dispatcher with no storage. That‚Äôs why there is a separate DispatcherStorage to keep all the data it needs. Also, the <strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">address of the DispatcherStorage needs to be hardcoded in the Dispatcher contract‚Äôs bytecode</em></strong>.</li></ul><p name="4e89" id="4e89" class="graf graf--p graf-after--li">Note that for the user-facing contract(Token contract) nothing special is needed, only that instead of being linked with the concrete version of the library, it has to be linked with the dispatcher.</p><p name="45e9" id="45e9" class="graf graf--p graf-after--p">Here is the implementation of the solution:</p><div name="048f" id="048f" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/maraoz/solidity-proxy/blob/master/test/test.es6" data-href="https://github.com/maraoz/solidity-proxy/blob/master/test/test.es6" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/maraoz/solidity-proxy/blob/master/test/test.es6"><strong class="markup--strong markup--mixtapeEmbed-strong">maraoz/solidity-proxy</strong><br><em class="markup--em markup--mixtapeEmbed-em">Solidity implementation of a delegate proxy. Contribute to maraoz/solidity-proxy development by creating an account on‚Ä¶</em>github.com</a><a href="https://github.com/maraoz/solidity-proxy/blob/master/test/test.es6" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="46baae78e29767ac1ec77103127a4c85" data-thumbnail-img-id="0*KUn3CXkrlRKJ8TCK" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*KUn3CXkrlRKJ8TCK);"></a></div><p name="b6cf" id="b6cf" class="graf graf--p graf-after--mixtapeEmbed graf--trailing">Happy Pseudo-Versioning!</p></div></div></section><section name="bcaf" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="1811" id="1811" class="graf graf--p graf--leading"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Sources:</em></strong></p><p name="bc00" id="bc00" class="graf graf--p graf-after--p"><a href="https://medium.com/aragondec/library-driven-development-in-solidity-2bebcaf88736#.sw5486wgv" data-href="https://medium.com/aragondec/library-driven-development-in-solidity-2bebcaf88736#.sw5486wgv" class="markup--anchor markup--p-anchor" target="_blank">Jorge Izquierdo‚Äôs article on Library Driven Development</a></p><p name="fb0a" id="fb0a" class="graf graf--p graf-after--p graf--trailing"><a href="http://truffleframework.com/tutorials/testing-for-throws-in-solidity-tests" data-href="http://truffleframework.com/tutorials/testing-for-throws-in-solidity-tests" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Simon de la Rouviere‚Äôs article on ThrowProxy</a></p></div></div></section><section name="0324" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="5864" id="5864" class="graf graf--p graf--leading">Thanks for reading¬†;)</p><figure name="e1ef" id="e1ef" class="graf graf--figure graf--layoutOutsetLeft graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 370px; max-height: 370px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 100%;"></div><img class="graf-image" data-image-id="1*PLw22EAlfu-TQhvLa6r4Yg.jpeg" data-width="370" data-height="370" src="https://cdn-images-1.medium.com/max/600/1*PLw22EAlfu-TQhvLa6r4Yg.jpeg"></div></figure><p name="ee7d" id="ee7d" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">About the Author</strong></p><p name="3cad" id="3cad" class="graf graf--p graf-after--p"><a href="http://vaibhavsaini.com/" data-href="http://vaibhavsaini.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Vaibhav Saini</a> is a Co-Founder of <a href="http://towardsblockchain.com" data-href="http://towardsblockchain.com" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">TowardsBlockchain</em></strong></a><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">, </em></strong><em class="markup--em markup--p-em">an MIT Cambridge Innovation Center incubated startup.</em></p><p name="e0c8" id="e0c8" class="graf graf--p graf-after--p">He works as Senior blockchain developer and has worked on several blockchain platforms including Ethereum, Quorum, EOS, Nano, Hashgraph, IOTA etc.</p><p name="b36c" id="b36c" class="graf graf--p graf-after--p">He is currently a sophomore at <a href="http://www.iitd.ac.in/" data-href="http://www.iitd.ac.in/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">IIT Delhi</a>.</p><h4 name="dc58" id="dc58" class="graf graf--h4 graf-after--p">Learned something? Press and hold the üëè to say ‚Äúthanks!‚Äù and help others find this¬†article.</h4><p name="abe6" id="abe6" class="graf graf--p graf-after--h4"><em class="markup--em markup--p-em">Hold down the clap button if you liked the content! It helps me gain exposure¬†.</em></p><p name="3a73" id="3a73" class="graf graf--p graf-after--p graf--trailing">Want to learn more? Checkout my previous articles.</p></div></div></section><section name="3e0e" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><div name="1647" id="1647" class="graf graf--mixtapeEmbed graf--leading"><a href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" data-href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f"><strong class="markup--strong markup--mixtapeEmbed-strong">ConsensusPedia: An Encyclopedia of 30 Consensus Algorithms</strong><br><em class="markup--em markup--mixtapeEmbed-em">A complete list of all consensus algorithms.</em>hackernoon.com</a><a href="https://hackernoon.com/consensuspedia-an-encyclopedia-of-29-consensus-algorithms-e9c4b4b7d08f" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="03bbca255c9ab55c0112e7879627edb3" data-thumbnail-img-id="0*y462aeJ4wg8HHYSs" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*y462aeJ4wg8HHYSs);"></a></div><div name="4e25" id="4e25" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" data-href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5"><strong class="markup--strong markup--mixtapeEmbed-strong">ContractPedia: An Encyclopedia of 40 Smart Contract Platforms</strong><br><em class="markup--em markup--mixtapeEmbed-em">A Complete List of all Smart Contract supportive Platforms</em>hackernoon.com</a><a href="https://hackernoon.com/contractpedia-an-encyclopedia-of-40-smart-contract-platforms-4867f66da1e5" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="a949ea9028a00c3bb62dfc3f160efc92" data-thumbnail-img-id="0*zDyDSLiGCSPQHEMq.jpg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*zDyDSLiGCSPQHEMq.jpg);"></a></div><div name="921b" id="921b" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" data-href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707"><strong class="markup--strong markup--mixtapeEmbed-strong">Difference between SideChains and State Channels</strong><br><em class="markup--em markup--mixtapeEmbed-em">A complete comparison of the two scaling methods.</em>hackernoon.com</a><a href="https://hackernoon.com/difference-between-sidechains-and-state-channels-2f5dfbd10707" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="096410b77bc232079dc957910f44555f" data-thumbnail-img-id="1*UmKkLx0_zCrwX1etzE-TRg.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*UmKkLx0_zCrwX1etzE-TRg.jpeg);"></a></div><div name="d8ac" id="d8ac" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://hackernoon.com/eos-101-getting-started-with-eos-part-1-ab0324c233e0" data-href="https://hackernoon.com/eos-101-getting-started-with-eos-part-1-ab0324c233e0" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hackernoon.com/eos-101-getting-started-with-eos-part-1-ab0324c233e0"><strong class="markup--strong markup--mixtapeEmbed-strong">EOS 101: Getting started with EOS, Part 1</strong><br><em class="markup--em markup--mixtapeEmbed-em">The only blockchain which has blocktime of less than a second: 0.5 sec!</em>hackernoon.com</a><a href="https://hackernoon.com/eos-101-getting-started-with-eos-part-1-ab0324c233e0" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="fd8747ef4c18e7ed85fa1f826a789f6f" data-thumbnail-img-id="1*_BKG3utRCovL4A9s78vEpA.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*_BKG3utRCovL4A9s78vEpA.png);"></a></div><p name="7591" id="7591" class="graf graf--p graf-after--mixtapeEmbed graf--trailing"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Clap 50 times and follow me on Twitter: </em></strong><a href="https://twitter.com/vasa_develop" data-href="https://twitter.com/vasa_develop" class="markup--anchor markup--p-anchor" rel="noopener nofollow nofollow noopener nofollow noopener noopener noopener noopener noopener noopener noopener noopener" target="_blank"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">@vasa_develop</em></strong></a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@vaibhavsaini_67863" class="p-author h-card">vasa</a> on <a href="https://medium.com/p/910007057943"><time class="dt-published" datetime="2018-12-16T05:44:58.198Z">December 16, 2018</time></a>.</p><p><a href="https://medium.com/@vaibhavsaini_67863/how-to-write-upgradable-versioned-smart-contracts-in-solidity-910007057943" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 19, 2019.</p></footer></article></body></html>